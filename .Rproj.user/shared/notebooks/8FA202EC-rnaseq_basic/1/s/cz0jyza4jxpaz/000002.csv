"0","bamcoverage <- function (bamfile) {"
"0","  # read in the bam file"
"0","  bam <- scanBam(bamfile)[[1]] # the result comes in nested lists"
"0","  # filter reads without match position"
"0","  ind <- ! is.na(bam$pos)"
"0","  ## remove non-matches, they are not relevant to us"
"0","  bam <- lapply(bam, function(x) x[ind])"
"0","  ranges <- IRanges(start=bam$pos, width=bam$qwidth, names=make.names(bam$qname, unique=TRUE))"
"0","  ## names of the bam data frame:"
"0","  ## ""qname""  ""flag""   ""rname""  ""strand"" ""pos""    ""qwidth"""
"0","  ## ""mapq""   ""cigar""  ""mrnm""   ""mpos""   ""isize""  ""seq""    ""qual"""
"0","  ## construc: genomic ranges object containing all reads"
"0","  ranges <- GRanges(seqnames=Rle(bam$rname), ranges=ranges, strand=Rle(bam$strand), flag=bam$flag, readid=bam$rname )"
"0","  ## returns a coverage for each reference sequence (aka. chromosome) in the bam file"
"0","  return (mean(coverage(ranges)))      "
"0","}"
